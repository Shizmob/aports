# Contributor: Shiz <hi@shiz.me>
# Maintainer: Shiz <hi@shiz.me>
pkgname=elftoolchain
pkgver=0.7.1
pkgrel=0
_tetver=3.8
pkgdesc="BSD licensed implementations of essential compilation tools and libraries for building and analyzing ELF based program images"
url="https://sourceforge.net/p/elftoolchain"
arch="all"
license="BSD"
makedepends_build="bmake m4 groff bison flex patch chrpath"
makedepends_host="bsd-compat-headers libarchive-dev zlib-dev"
subpackages="$pkgname-dev $pkgname-doc"
source="http://downloads.sourceforge.net/$pkgname/$pkgname-$pkgver.tgz
	fix-distro-detection.patch"
builddir="$srcdir/$pkgname-$pkgver"
options="!check"  # tests are broken

if [ "$CHOST" != "$CTARGET" ]; then
	pkgname="$pkgname-$CTARGET_ARCH"
	subpackages=
	sonameprefix="$pkgname:"
fi

build() {
	cd "$builddir"
	# -j1 is needed due some messed up dependencies.
	bmake -j1 MK_PROFILE=no WITH_TESTS=no
}

package() {
	cd "$builddir"
	bmake DESTDIR="$pkgdir" MK_PROFILE=no WITH_TESTS=no install

	cd "$pkgdir"
	if [ "$CHOST" != "$CTARGET" ]; then
		# migrate /usr to /usr/$CTARGET and symlink back.
		mkdir -p "$CTARGET"/bin
		mv lib "$CTARGET"

		local prog; for prog in bin/*; do
			chrpath -r '$ORIGIN/../lib' "$prog"
			mv "$prog" "$CTARGET"/bin
			ln -s ../"$CTARGET"/"$prog" bin/"$CTARGET"-$(basename "$prog")
		done
	fi
}

sha512sums="4978c119532a2e3b32903f05fa3f02c52465ca62bce269344a70916aa40c806b0b91c26eef3e2308693fec668db25599be615f13097364aa548e6080adb637d2  elftoolchain-0.7.1.tgz
9ec286e9e704fad7b9cfec43a5ffa21543cd8b4fe1ac99702299ed30aad9eebd0bbc35ee846330f4ac71e388176260a9697de2bbf311a71e0170815b646ca303  fix-distro-detection.patch"
