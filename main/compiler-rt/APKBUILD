# Contributor Travis Tilley <ttilley@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=compiler-rt
# Note: Update together with llvm.
pkgver=4.0.0
pkgrel=1
_llvmver=${pkgver%%.*}
pkgdesc="LLVM compiler-rt runtime libraries"
arch="all"
url="http://llvm.org/"
license="UOI-NCSA"
makedepends="
	cmake
	linux-headers
	llvm-dev>=$_llvmver
	llvm-static>=$_llvmver
	python2
	"
checkdepends="llvm-utils>=$_llvmver"
source="http://llvm.org/releases/$pkgver/$pkgname-$pkgver.src.tar.xz
	dont-test-unbuilt-sanitizers.patch"
builddir="$srcdir/$pkgname-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	cmake .. \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCOMPILER_RT_BUILD_SANITIZERS=OFF \
		-DCOMPILER_RT_BUILD_XRAY=OFF \
		-DCOMPILER_RT_INCLUDE_TESTS=ON
	make
}

check() {
	cd "$builddir"/build
	make check-compiler-rt
}

package() {
	cd "$builddir"/build

	make DESTDIR="$pkgdir" install

	cd "$pkgdir"

	mkdir -p usr/lib/clang
	case "$CARCH" in
		ppc64le | s390x) ;;
		*) mv usr/lib/linux usr/lib/clang/$pkgver;;
	esac
}

sha512sums="ed52436a2399ca82c1af46a523e89e88c23367f74cd110f0267af49a72aa4912ae8f48c6093e6b01c9ea68c48354a12201d26baf721d254fb017ddb98af2e3dd  compiler-rt-4.0.0.src.tar.xz
b0c3dac34820e8b95f461c5b9025e154f2244237e38ed3fa482baea8233686e0c40c7ae8f572513161856313029db40566bf4d21f102a554e556b45d8d0ef794  dont-test-unbuilt-sanitizers.patch"
