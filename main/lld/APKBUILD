# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=lld
pkgver=4.0.0
pkgrel=1
_llvmver=${pkgver%%.*}
pkgdesc="The LLVM Linker"
url="http://llvm.org"
arch="all"
license="UOI-NCSA"
makedepends_host="llvm-dev>=$_llvmver llvm-static>=$_llvmver llvm-utils zlib-dev"
makedepends_build="cmake"
checkdepends="gtest gtest-dev"
if [ "$CBUILD" != "$CHOST" ]; then
	makedepends_build="$makedepends_build llvm-config-$CTARGET_ARCH>=$_llvmver llvm-utils>=$_llvmver"
fi
subpackages="$pkgname-dev"
source="http://llvm.org/releases/$pkgver/$pkgname-$pkgver.src.tar.xz
	cmake-fix-pthread-handling-for-out-of-tree-builds.patch
	cmake-support-running-tests-in-stand-alone-builds.patch
	fix-standalone-test-suite.patch
	add-compatible-with-gnu-linkers-to-version-output.patch
	print-out-supported-targets.patch
	implement-znotext.patch"
builddir="$srcdir/$pkgname-$pkgver.src"

# See the LLVM APKBUILD for rationale.
_prefix="usr/lib/llvm$_llvmver"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	local cross
	if [ "$CBUILD" != "$CHOST" ]; then
		cp /$_prefix/bin/llvm-config-$CTARGET_ARCH $CBUILDROOT/$_prefix/bin/llvm-config-$CTARGET_ARCH
		cross=" -DCMAKE_CROSSCOMPILING=ON
			-DCMAKE_SYSTEM_NAME=Linux
			-DCMAKE_SYSTEM_PREFIX_PATH=$CBUILDROOT/usr;$CBUILDROOT
			-DLLVM_CONFIG_PATH=$CBUILDROOT/$_prefix/bin/llvm-config-$CTARGET_ARCH
			-DLLVM_TABLEGEN_EXE=/$_prefix/bin/llvm-tblgen
		"
	fi

	cmake .. \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DLLVM_ENABLE_LIBCXX=ON \
		-DLLVM_INCLUDE_TESTS=ON \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		$cross
	rm -f $CBUILDROOT/$_prefix/bin/llvm-config-$CTARGET_ARCH

	make
}

check() {
	cd "$builddir"/build

	make check-lld
}

package() {
	cd "$builddir"/build

	make install DESTDIR="$pkgdir"
}

sha512sums="66b2c9cc57f5e94ad7e7da1b1bcc08cbbaee1b55c6efa64b2424b9d8776c70b842c2a31c188a99b447be6a8621ad1b1e70573bbfcf5d6b1aa986b03b3b3350f3  lld-4.0.0.src.tar.xz
2aa44973dd86aaddbd5b21789bb5e2a611d00558c41ebd078c2b7d1a3eb5c303db69084f50517b14e77674c46148ecae6bde1b037d8ba5269a342fba84116a9b  cmake-fix-pthread-handling-for-out-of-tree-builds.patch
5871cd12512494a8914b0079ef2deceb37396ad9eafedd21969bf74e8889f5252dcfde1d1d3d06ac447e5317287faa678b74bed6102d20ada5dfda56bfa33e7c  cmake-support-running-tests-in-stand-alone-builds.patch
03f9cab3efff93a077dd98a7d80feaf974dbde6f07c5604a5a3b7dab9fc5f225e7bb0a13e9a7b781dacf14d1e659546a535e353dba496b570e235311dba0bb5a  fix-standalone-test-suite.patch
78c5901d2614dd6089544d85505153228c8ea419cf8c0ccddd7cf1945397f6ffb6d2e0fc1f77ceb6946dd3b680c61d458091fd1084324bab1546c5f68c7cb21b  add-compatible-with-gnu-linkers-to-version-output.patch
0321a810be0c74625532e409f5042424614584a1e5451168580825062bc77915632690a2ed14f37c820306271620d7a11f61e556be1f02313bae844e99119d5b  print-out-supported-targets.patch
72ab3bc13ced2e8e9d246afcf60dfe8c3a74d6403df4e34d665acb70fb7de692aa32428d5be8f5b5ee65d2b9026b2aa9d66577890a057aeb5d08926856e6d750  implement-znotext.patch"
